<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTE Day 1: RA & RS Intensive Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        .mic-pulse {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .progress-bar {
            transition: width 1s linear;
        }

        /* Scrollbar for the results section */
        .results-container::-webkit-scrollbar {
            width: 8px;
        }
        .results-container::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .results-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .results-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Nav Grid Scrollbar */
        .nav-grid::-webkit-scrollbar {
            height: 4px;
        }
        .nav-grid::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 2px;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 text-white shadow-lg z-10 flex flex-col">
        <div class="p-4 flex justify-between items-center border-b border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-bold text-xl">1</div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Day 1 Intensive</h1>
                    <p class="text-xs text-slate-400">Read Aloud (20) & Repeat Sentence (30)</p>
                </div>
            </div>
            <div class="text-right">
                <!-- Global Timer (Total Session Time) -->
                <div class="text-2xl font-mono font-bold" id="header-timer">00:00</div>
                <div class="text-xs text-slate-400 uppercase tracking-wider" id="header-status">Ready</div>
            </div>
        </div>
        
        <!-- Navigation Grid -->
        <div class="bg-slate-800 p-2 overflow-x-auto whitespace-nowrap nav-grid flex gap-2 items-center" id="nav-container">
            <!-- Injected via JS -->
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative flex flex-col items-center justify-center p-4 overflow-y-auto bg-slate-100">
        
        <!-- WELCOME SCREEN -->
        <div id="screen-welcome" class="max-w-md w-full bg-white rounded-xl shadow-xl p-8 text-center">
            <i class="fas fa-headset text-6xl text-blue-500 mb-6"></i>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Ready to Practice?</h2>
            <p class="text-slate-600 mb-6">This session includes 20 Read Alouds followed by 30 Repeat Sentences.</p>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 text-left text-sm text-yellow-800 mb-6">
                <strong>Requirements:</strong>
                <ul class="list-disc ml-4 mt-1">
                    <li>Use Chrome or Edge for Speech-to-Text.</li>
                    <li>Allow microphone access (once at start).</li>
                    <li>Find a quiet room.</li>
                </ul>
            </div>

            <button onclick="startPractice()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition transform hover:scale-105 shadow-lg">
                Start Session
            </button>
        </div>

        <!-- ACTIVE QUESTION INTERFACE -->
        <div id="screen-active" class="hidden w-full max-w-4xl bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col" style="min-height: 500px;">
            
            <!-- Question Header / Status -->
            <div class="bg-slate-50 border-b border-slate-200 p-4 flex justify-between items-center">
                <span id="task-type-badge" class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider">Read Aloud</span>
                <div class="text-sm text-slate-500">Question <span id="q-index-display">1</span> of 50</div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 p-8 flex flex-col justify-center items-center text-center relative">
                
                <!-- Read Aloud Text -->
                <p id="ra-text-display" class="text-xl md:text-2xl leading-relaxed font-medium text-slate-800 hidden">
                    <!-- Text injected via JS -->
                </p>

                <!-- Repeat Sentence Audio Placeholder -->
                <div id="rs-interface" class="hidden flex-col items-center justify-center w-full">
                    <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-6 animate-pulse" id="audio-icon-container">
                        <i class="fas fa-volume-up text-4xl text-blue-500"></i>
                    </div>
                    <p class="text-slate-500 text-lg" id="rs-status-text">Listen carefully...</p>
                    <audio id="rs-audio-player" class="hidden"></audio>
                </div>

                <!-- Status Message overlay -->
                <div id="status-overlay" class="mt-8 text-lg font-semibold text-blue-600 transition-opacity duration-300">
                    Preparing...
                </div>

                <!-- Live Waveform -->
                <div id="live-waveform" class="w-full h-32 mt-8 opacity-0 transition-opacity duration-500"></div>

            </div>

            <!-- Footer Controls -->
            <div class="bg-slate-100 p-4 border-t border-slate-200">
                
                <!-- Progress Bar Area -->
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex-1 bg-slate-300 h-2 rounded-full overflow-hidden relative">
                        <div id="timer-bar" class="bg-blue-600 h-full w-0 progress-bar absolute top-0 left-0"></div>
                    </div>
                    <!-- Countdown Timer Text -->
                    <div id="bar-timer-text" class="font-mono font-bold text-slate-700 w-12 text-right">00:00</div>
                </div>

                <div class="flex justify-between items-center gap-4">
                    <!-- Dynamic Action Button (Skip Prep / Stop Recording) -->
                    <button id="btn-action" onclick="handleAction()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded shadow font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        Skip Prep
                    </button>

                    <!-- Next Button -->
                    <button id="btn-next" onclick="forceNext()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded shadow font-semibold transition-all">
                        Next <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="screen-results" class="hidden w-full max-w-5xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh]">
            <div class="p-6 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800">Session Complete!</h2>
                <div class="flex gap-2">
                    <button onclick="window.location.reload()" class="text-blue-600 hover:text-blue-800 font-semibold text-sm">Start New Session</button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 results-container space-y-6" id="results-list">
                <!-- Results items injected here -->
            </div>
        </div>

    </main>

    <!-- JS Logic -->
    <script>
        // --- DATA CONFIGURATION ---
        
        // 1. READ ALOUD DATA (20 Questions)
        const raTexts = [
            "The well-being, prosperity, and sustainability of human enterprise rely on the functioning of the Earth's natural systems and their complex physical, chemical, and biological processes. Water is a central theme in all terrestrial, oceanic, atmospheric, agricultural, and industrial systems.",
            "Teaching is indeed a challenging profession, yet it continues to attract and retain individuals year after year, many of whom remain in the field for five, ten, or even more years. This enduring commitment can be attributed to a combination of intrinsic motivations and the rewarding aspects of the profession.",
            "Schools host parent teacher conferences four times a year and it is important for families to attend. This is your chance to meet with teachers and ask questions about your child's progress. It can be helpful to write down questions ahead of time.",
            "The exponential growth of the internet was heralded, in the 1990s, as revolutionizing the production and dissemination of information. Some people saw the internet as a means of democratizing access to knowledge. For people concerned with African development, it seemed to offer the possibility of leap frogging over the technology gap that separates Africa from advanced industrialized countries.",
            "The word radical from the Latin word for roots means anyone who advocates fundamental change in the political system. Literally, a radical is one who proposes to attack some political or social problem by going deep into the social or economic fabric to get at the root cause and alter this basic weakness.",
            "Today, telecommunication is widespread and devices that assist the progress are common in many parts of the world. There is also a vast array of networks that connect these devices, including a computer, telephone, and cable networks. Computer communication across the Internet, such as email and instant messaging, is just one of many examples of telecommunication.",
            "The starting point of Bergson's theory is the experience of time and motion. Time is the reality we experience most directly, but this doesn't mean that we can capture this experience mentally. The past is gone and the future is yet to come. The only reality is the present, which is real through our experience.",
            "To some extent, attendance at cultural venues and events is influenced by a person's age and the composition of the household in which they live. For example, those people in households with dependent children were more likely to visit zoological parks and aquariums than people living in single person households.",
            "At a time when stress levels are soaring, rates of depression are increasing and the gap between rich and poor is ever widening. We believe that giving can play a positive role in helping people to feel connected to those around them and generate a sense of purpose and hope. When we give, we feel valued, useful and happy.",
            "380 years after his death, William Shakespeare remains the central author of the English speaking world; he is the most quoted poet and the most regularly produced playwright and now among the most popular screenwriters as well. Why is that, and who \"is\" he? Why do so many people think his writing is so great? What meanings did his plays have in his own time, and how do we read, speak, or listen to his words now?",
            "There were various explanations for volcano behaviour before the structure of the earth's mantle as a semisolid material was developed. For decades, awareness that compression and radioactive materials may be heat sources was discounted and volcanic action was often attributed to chemical reactions and a thin layer of molten rock near the surface.",
            "The whole purpose of making notes is to aid your learning. It is important to go back over them within a day of making them to make sure they make sense and make them legible for future revisions. Also, going back over them should highlight the key questions of areas in which you want to do further reading.",
            "Most babies start developing their hearing while still in the womb, prompting some hopeful parents to play classical music to their pregnant bellies. Some research even suggests that infants are listening to adult speech as early as 10 weeks before birth, gathering the basic building blocks of their family's native tongue.",
            "We have spent a lot of money over the last 70 years on flood control, and it's protected millions of people and has saved us billions of dollars. We've built dams to hold back the waters. We've built levees to keep the water off the people, and we've raised the ones that were originally started in 1718.",
            "The noise restrictions are based on measurements on animals in captivity exposed to noise levels that induce a temporary threshold shift (TTS) in hearing. The TTS onset threshold is the lowest noise exposure capable of inducing a small temporary reduction of hearing sensitivity, also known as auditory fatigue, with full recovery shortly after exposure.",
            "Tissues are grouped together in the body to form organs. These include the brain, heart, lungs, kidneys, and liver. Each body organ has a specific shape and is made up of different types of tissue that work together. For example, the heart consists mainly of a specialized type of muscle tissue, which contracts rhythmically to provide the heart's pumping action.",
            "The audio, which includes more than 1,000 separate data files, was captured in the early 1970s by the late Hetty van de Rijt. She recorded the various screams, barks, and how calls made by a group of chimps, including 17 youngsters, living in the Gombe National Park in Tanzania.",
            "The Royal Institution is an organisation that has been around for 209 years. Many of the people that have worked here have been scientists themselves, including Michael Faraday. He made the discoveries that may be generating a using electricity much easier, making it possible for us all to switch on lights, cook for dinner, play games consoles much more.",
            "Australia has one of the world's most important mining industries. It is a major exporter of coal, iron ore, gold, and copper and is self sufficient in all minerals and bar petroleum. Since the first discoveries, the coal in 1798, mineral production has risen every year in the decade, and in 1992 it doubled.",
            "In spite of the spectacularly high quality of life for the vast majority of the people who live in the European Union, its inhabitant seems obsessed by the region's relative decline in the world. Slow economic growth rates and high unemployment have reinforced the impression that Europe is unhappy with today and unsure of tomorrow."
        ];

        const raQuestions = raTexts.map((text, i) => ({
            id: `RA-${i+1}`,
            type: 'RA',
            text: `[Q${i+1}] ${text}`
        }));

        // 2. REPEAT SENTENCE DATA (30 Questions, 011-040)
        const rsTranscripts = {
            "011": "Psychology relies on scientific methods to investigate questions and arrive at conclusions",
            "012": "The professor predicts that biotechnology is the future of traditional biology.",
            "013": "There has been a delay in processing the enrollment due to computer problems",
            "014": "Globalization has been an overwhelming urbanization phenomenon",
            "015": "No crop responds more readily than careful husbandry and skillful cultivation",
            "016": "There are various approaches to plagiarism across different university departments",
            "017": "There are several reasons for this lack of interest in corporate crime, compared with other type of crime",
            "018": "Every car maker in Europe has sort of been on the blocks because of their dependence on diesel",
            "019": "Mitosis is the division of cells for growth and repair",
            "020": "You can register your card at the university student center or the library",
            "021": "The art museum is located across the street and near the theater.",
            "022": "A public telephone is available in the shop.",
            "023": "Your wages will be put into your bank account on Thursday.",
            "024": "The library will be closed during summer vacation.",
            "025": "I need somebody to fix the problem with the computer screen.",
            "026": "Your son has a bad cold and is in the nurse's room.",
            "027": "You can speak to the current students at the information sessions.",
            "028": "Several people have applied for this position.",
            "029": "Passengers on the train should not put their feet on the seat.",
            "030": "If you take a part-time job, ensure it doesnâ€™t interfere with your studies.",
            "031": "The building will be closed and reopened next week.",
            "032": "The library is downstairs on the east side of the building.",
            "033": "You must wear a hard hat on the construction site.",
            "034": "Your car can park in the building behind the medical center.",
            "035": "If finance is a cause for concern, scholarships may be available.",
            "036": "One theory says that dreams help the long term memory.",
            "037": "Not everyone wants to keep in touch with their old school friends when they leave school.",
            "038": "Before electric lighting, adults generally slept about 9 or 10 hours per night.",
            "039": "Even now, scientists still don't know whether animals dream while they sleep",
            "040": "Find a bookstore situated on the main campus northern side."
        };

        const rsQuestions = Array.from({length: 30}, (_, i) => {
            const num = (i + 11).toString().padStart(3, '0');
            return {
                id: `RS-${num}`,
                type: 'RS',
                audioSrc: `https://baongocnguyenngo2018-bot.github.io/PTE/03.repeat-sentence/${num}.mp3`,
                text: rsTranscripts[num] || "Transcript not available."
            };
        });

        const allQuestions = [...raQuestions, ...rsQuestions];
        
        // --- STATE MANAGEMENT ---
        let currentIndex = 0;
        let userResponses = []; 
        let mediaRecorder;
        let audioChunks = [];
        let wavesurferLive;
        let recognition;
        let globalStream = null; 
        let timerInterval;
        let appState = 'IDLE'; 
        let resultAudioPlayer = null; // Separate player for results
        
        // DOM Elements
        const screens = {
            welcome: document.getElementById('screen-welcome'),
            active: document.getElementById('screen-active'),
            results: document.getElementById('screen-results')
        };
        const els = {
            navContainer: document.getElementById('nav-container'),
            headerTimer: document.getElementById('header-timer'),
            headerStatus: document.getElementById('header-status'),
            qIndex: document.getElementById('q-index-display'),
            badge: document.getElementById('task-type-badge'),
            raText: document.getElementById('ra-text-display'),
            rsInterface: document.getElementById('rs-interface'),
            audioPlayer: document.getElementById('rs-audio-player'),
            rsStatusText: document.getElementById('rs-status-text'),
            statusOverlay: document.getElementById('status-overlay'),
            timerBar: document.getElementById('timer-bar'),
            barTimerText: document.getElementById('bar-timer-text'),
            btnAction: document.getElementById('btn-action'),
            btnNext: document.getElementById('btn-next'),
            liveWave: document.getElementById('live-waveform')
        };

        // --- INITIALIZATION ---

        async function startPractice() {
            try {
                // Initialize Stream ONCE
                globalStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                wavesurferLive = WaveSurfer.create({
                    container: '#live-waveform',
                    waveColor: '#ef4444',
                    progressColor: '#b91c1c',
                    barWidth: 3,
                    cursorWidth: 0,
                    height: 100,
                    normalize: true
                });

                showScreen('active');
                renderNavBar();
                loadQuestion(0);

            } catch (err) {
                alert("Microphone access is required to proceed.");
                console.error(err);
            }
        }

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[name].classList.remove('hidden');
        }

        function renderNavBar() {
            els.navContainer.innerHTML = '';
            allQuestions.forEach((q, i) => {
                const btn = document.createElement('button');
                // Styling: Current (Blue), Completed (Green), Future (Gray)
                let baseClass = "w-8 h-8 rounded text-xs font-bold shrink-0 transition-colors border ";
                if (i === currentIndex) {
                    baseClass += "bg-blue-600 text-white border-blue-700 shadow-md transform scale-110";
                } else if (userResponses[i] && userResponses[i].blob) {
                    baseClass += "bg-green-100 text-green-700 border-green-200 hover:bg-green-200";
                } else {
                    baseClass += "bg-slate-700 text-slate-400 border-slate-600 hover:bg-slate-600";
                }

                btn.className = baseClass;
                btn.innerText = i + 1;
                btn.onclick = () => {
                    // Force stop current question if user jumps
                    clearInterval(timerInterval);
                    stopMediaRecorder(); // Will fail to save if recording, but prevents crash
                    loadQuestion(i);
                };
                els.navContainer.appendChild(btn);
            });
            
            // Scroll to current
            const activeBtn = els.navContainer.children[currentIndex];
            if(activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }

        // --- QUESTION LOGIC ---

        function loadQuestion(index) {
            if (index >= allQuestions.length) {
                finishSession();
                return;
            }

            // Cleanup previous state
            clearInterval(timerInterval);
            
            // Safe pause for audio
            try {
                els.audioPlayer.pause();
                els.audioPlayer.currentTime = 0;
            } catch(e) { console.log("Audio reset warning", e); }
            
            currentIndex = index;
            renderNavBar(); 
            
            const q = allQuestions[index];
            els.qIndex.innerText = index + 1;
            
            // UI Reset
            els.statusOverlay.style.opacity = '1';
            els.statusOverlay.className = "mt-8 text-lg font-semibold text-slate-600";
            els.liveWave.style.opacity = '0';
            
            // Data Reset - keep existing if revisiting, or init new
            if(!userResponses[index]) {
                userResponses[index] = { id: q.id, type: q.type, blob: null, transcript: '' };
            }

            if (q.type === 'RA') setupRA(q);
            else setupRS(q);
        }

        // --- ACTION BUTTON HANDLER ---
        function handleAction() {
            if (appState === 'PREP') {
                clearInterval(timerInterval);
                if (allQuestions[currentIndex].type === 'RA') {
                    playSound('beep');
                    startRecordingRA(40);
                } else {
                    startRecordingRS(15);
                }
            } else if (appState === 'RECORDING') {
                clearInterval(timerInterval);
                if (allQuestions[currentIndex].type === 'RA') stopRecordingRA();
                else stopRecordingRS();
            }
        }

        function updateActionButton(text, state, enabled = true) {
            els.btnAction.innerText = text;
            els.btnAction.disabled = !enabled;
            appState = state;
            
            if (state === 'RECORDING') {
                els.btnAction.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                els.btnAction.classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                els.btnAction.classList.add('bg-blue-600', 'hover:bg-blue-700');
                els.btnAction.classList.remove('bg-red-600', 'hover:bg-red-700');
            }
        }

        // --- READ ALOUD FLOW ---
        function setupRA(q) {
            els.badge.innerText = "Read Aloud";
            els.badge.className = "bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider";
            els.raText.innerText = q.text;
            els.raText.classList.remove('hidden');
            els.rsInterface.classList.add('hidden');

            updateActionButton("Skip Prep", 'PREP');
            runTimer(35, "Preparation", () => {
                playSound('beep');
                startRecordingRA(40);
            });
        }

        function startRecordingRA(duration) {
            updateActionButton("Stop Recording", 'RECORDING');
            els.statusOverlay.innerText = "Recording...";
            els.statusOverlay.className = "mt-8 text-2xl font-bold text-red-600 mic-pulse";
            els.liveWave.style.opacity = '1';

            // Pass callback to execute AFTER stop completes
            startMediaRecorder(() => {
                saveResponse();
                loadQuestion(currentIndex + 1);
            });
            
            runTimer(duration, "Recording", () => {
                stopRecordingRA();
            });
        }

        function stopRecordingRA() {
            stopMediaRecorder();
        }

        // --- REPEAT SENTENCE FLOW ---
        function setupRS(q) {
            els.badge.innerText = "Repeat Sentence";
            els.badge.className = "bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider";
            els.raText.classList.add('hidden');
            els.rsInterface.classList.remove('hidden');
            
            const audioIcon = document.getElementById('audio-icon-container');
            audioIcon.classList.add('animate-pulse', 'bg-blue-50');
            audioIcon.classList.remove('bg-red-50');
            document.querySelector('#audio-icon-container i').className = "fas fa-volume-up text-4xl text-blue-500";
            
            els.statusOverlay.innerText = "Playing Audio...";
            els.rsStatusText.innerText = "Listen carefully...";
            
            updateActionButton("Playing...", 'PLAYING_AUDIO', false);

            els.audioPlayer.oncanplaythrough = null;
            els.audioPlayer.onended = null;
            els.audioPlayer.onerror = null;

            els.audioPlayer.src = q.audioSrc;
            
            const playAudioSafe = () => {
                els.audioPlayer.play()
                    .catch(err => {
                        console.error("Audio playback error:", err);
                        els.statusOverlay.innerText = "Audio Error";
                        els.rsStatusText.innerText = "Could not play audio source.";
                    });
            };

            els.audioPlayer.oncanplaythrough = () => {
                els.audioPlayer.oncanplaythrough = null;
                playAudioSafe();
            };
            
            els.audioPlayer.onerror = (e) => {
                console.error("Audio Load Error:", e);
                els.statusOverlay.innerText = "Audio Not Found";
                els.rsStatusText.innerText = "Please check URL.";
            };

            if(els.audioPlayer.readyState >= 3) {
                 playAudioSafe();
            }

            els.audioPlayer.onended = () => {
                els.statusOverlay.innerText = "Get Ready...";
                updateActionButton("Start Speaking", 'PREP');
                
                timerInterval = setTimeout(() => {
                    startRecordingRS(15);
                }, 1000);
            };
        }

        function startRecordingRS(duration) {
            clearTimeout(timerInterval);

            const audioIcon = document.getElementById('audio-icon-container');
            audioIcon.classList.remove('animate-pulse', 'bg-blue-50');
            audioIcon.classList.add('bg-red-50', 'mic-pulse');
            document.querySelector('#audio-icon-container i').className = "fas fa-microphone text-4xl text-red-500";
            els.rsStatusText.innerText = "Speak now!";

            updateActionButton("Stop Recording", 'RECORDING');
            els.statusOverlay.innerText = "Recording...";
            els.liveWave.style.opacity = '1';

            // Pass callback to execute AFTER stop completes
            startMediaRecorder(() => {
                saveResponse();
                loadQuestion(currentIndex + 1);
            });

            runTimer(duration, "Recording", () => {
                stopRecordingRS();
            });
        }

        function stopRecordingRS() {
            stopMediaRecorder();
        }

        // --- CORE UTILS ---

        function startMediaRecorder(onStopCallback) {
            if (!globalStream) {
                 console.error("No global stream available");
                 return;
            }
            
            mediaRecorder = new MediaRecorder(globalStream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                if(event.data.size > 0) audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                if (onStopCallback) onStopCallback();
            };

            mediaRecorder.start();
        }

        function stopMediaRecorder() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        function saveResponse() {
            if(audioChunks.length > 0) {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                userResponses[currentIndex].blob = blob;
            }
            // NO transcript logic here anymore.
            renderNavBar(); 
        }

        function forceNext() {
            clearInterval(timerInterval);
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            } else {
                try { els.audioPlayer.pause(); } catch(e) {}
                loadQuestion(currentIndex + 1);
            }
        }

        function runTimer(seconds, label, onComplete) {
            let remaining = seconds;
            els.headerTimer.innerText = "Session"; 
            els.headerStatus.innerText = label;
            
            els.barTimerText.innerText = formatTime(remaining);

            els.timerBar.style.transition = 'none';
            els.timerBar.style.width = '100%';
            
            void els.timerBar.offsetWidth;
            
            els.timerBar.style.transition = `width ${seconds}s linear`;
            els.timerBar.style.width = '0%';

            timerInterval = setInterval(() => {
                remaining--;
                els.barTimerText.innerText = formatTime(remaining);
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    onComplete();
                }
            }, 1000);
        }

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = s % 60;
            return `${min < 10 ? '0'+min : min}:${sec < 10 ? '0'+sec : sec}`;
        }

        function playSound(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 200);
        }

        // --- RESULTS PAGE & ON-DEMAND STT ---

        function finishSession() {
            showScreen('results');
            renderResults();
        }

        function renderResults() {
            const list = document.getElementById('results-list');
            list.innerHTML = '';

            userResponses.forEach((resp, i) => {
                const q = allQuestions.find(q => q.id === resp.id);
                if (!q) return;
                const isRA = q.type === 'RA';
                
                const card = document.createElement('div');
                card.className = "bg-white border border-slate-200 rounded-lg p-6 shadow-sm";
                
                let contentHtml = '';
                
                if (isRA) {
                    contentHtml = `
                        <div class="mb-4">
                            <h4 class="font-bold text-slate-700 mb-2">Original Text:</h4>
                            <p class="text-slate-600 bg-slate-50 p-3 rounded border border-slate-100">${q.text}</p>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-blue-700">Transcript:</h4>
                                ${resp.blob ? 
                                `<button onclick="transcribeRecording(${i})" id="btn-transcribe-${i}" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition-colors border border-blue-300">
                                    <i class="${resp.transcript ? 'fas fa-redo' : 'fas fa-magic'} mr-1"></i> ${resp.transcript ? 'Retry' : 'Transcribe'}
                                </button>` : ''}
                            </div>
                            <!-- Transcript Box with Fallback Textarea -->
                            <div id="transcript-container-${i}">
                                ${resp.transcript 
                                    ? `<p class="text-blue-800 bg-blue-50 p-3 rounded border border-blue-100 italic min-h-[40px]">${resp.transcript}</p>`
                                    : `<div class="relative">
                                         <p id="transcript-output-${i}" class="text-blue-800 bg-blue-50 p-3 rounded border border-blue-100 italic min-h-[40px] block">
                                            <span class="text-slate-400 text-xs">Click 'Transcribe' or type below...</span>
                                         </p>
                                         <textarea placeholder="Manual correction (if auto-transcribe fails)" class="w-full mt-2 p-2 text-sm border rounded text-slate-600 bg-white" rows="2"></textarea>
                                       </div>`
                                }
                            </div>
                            <div class="mt-2 text-[11px] text-red-500 bg-red-50 p-2 rounded border border-red-100 flex gap-2 items-start">
                                <i class="fas fa-exclamation-circle mt-0.5"></i>
                                <span><strong>Warning:</strong> For transcription to work, you MUST unplug headphones and turn up speakers so the mic can hear the playback. (Loopback limitation)</span>
                            </div>
                        </div>
                    `;
                } else {
                    contentHtml = `
                        <div class="mb-4">
                            <div class="flex items-center gap-4">
                                <h4 class="font-bold text-slate-700">Original Audio:</h4>
                                <audio controls src="${q.audioSrc}" class="h-8"></audio>
                            </div>
                            <div class="mt-2">
                                <h4 class="font-bold text-slate-700 mb-1 text-sm">Transcript:</h4>
                                <p class="text-slate-600 bg-purple-50 p-2 rounded border border-purple-100 text-sm italic">${q.text}</p>
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-slate-400">#${i+1}</span>
                            <span class="${isRA ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'} text-xs font-bold px-2 py-1 rounded">${q.type}</span>
                        </div>
                    </div>
                    ${contentHtml}
                    <div class="mt-4 border-t border-slate-100 pt-4">
                        <h4 class="font-bold text-slate-700 mb-2">Your Recording:</h4>
                        ${resp.blob ? 
                            `<div id="wave-${i}" class="w-full h-24 bg-slate-50 rounded mb-2"></div>
                             <div class="flex justify-center">
                                <button id="play-btn-${i}" class="text-blue-600 hover:text-blue-800 font-bold text-sm flex items-center gap-2">
                                    <i class="fas fa-play"></i> Play Recording
                                </button>
                             </div>` 
                            : '<p class="text-red-500 italic text-sm">No recording made.</p>'}
                    </div>
                `;
                
                list.appendChild(card);

                if (resp.blob) {
                    setTimeout(() => {
                        try {
                            const ws = WaveSurfer.create({
                                container: `#wave-${i}`,
                                waveColor: '#94a3b8',
                                progressColor: '#2563eb',
                                height: 80,
                                barWidth: 2,
                                cursorWidth: 0,
                                url: URL.createObjectURL(resp.blob)
                            });
                            
                            const btn = document.getElementById(`play-btn-${i}`);
                            btn.onclick = () => ws.playPause();
                            ws.on('play', () => btn.innerHTML = '<i class="fas fa-pause"></i> Pause');
                            ws.on('pause', () => btn.innerHTML = '<i class="fas fa-play"></i> Play Recording');
                            ws.on('finish', () => btn.innerHTML = '<i class="fas fa-play"></i> Play Recording');
                        } catch (e) {
                            console.error("WaveSurfer init error", e);
                        }
                    }, 100);
                }
            });
        }

        // --- ON DEMAND TRANSCRIPTION LOGIC ---
        function transcribeRecording(index) {
            const resp = userResponses[index];
            if (!resp || !resp.blob) return;

            const btn = document.getElementById(`btn-transcribe-${index}`);
            // Use querySelector to find the output paragraph even if inside fallback div
            const output = document.getElementById(`transcript-output-${index}`) || document.querySelector(`#transcript-container-${index} p`);
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                if(output) output.innerText = "Error: Browser does not support Speech API.";
                return;
            }

            // UI Update
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Listening...';
            if(output) output.innerHTML = '<span class="text-blue-500 animate-pulse">Playing audio for transcription...</span>';

            // 1. Setup Recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (recognition) try { recognition.abort(); } catch(e){}
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            let tempFinal = '';
            
            recognition.onresult = (event) => {
                let tempInterim = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        tempFinal += event.results[i][0].transcript + '. ';
                    } else {
                        tempInterim += event.results[i][0].transcript;
                    }
                }
                if(output) output.innerText = (tempFinal + " " + tempInterim).trim();
            };

            recognition.onerror = (e) => {
                console.log("Transcription error", e);
                let msg = "Error";
                if (e.error === 'no-speech') msg = "No speech detected (Check volume)";
                if (e.error === 'not-allowed') msg = "Mic permission denied";
                if (e.error === 'network') msg = "Network error";
                
                if(output) output.innerText = msg;
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Retry';
                btn.disabled = false;
            };

            recognition.onend = () => {
                btn.innerHTML = '<i class="fas fa-redo"></i> Retry';
                btn.disabled = false;
                if(output) userResponses[index].transcript = output.innerText;
            };

            // 2. Start Recognition & Play Audio
            try {
                recognition.start();
                
                // Create a temporary audio player for the blob
                const audio = new Audio(URL.createObjectURL(resp.blob));
                audio.volume = 1.0;
                
                // Wait slightly for recognition to be ready
                setTimeout(() => {
                    audio.play().catch(e => {
                        if(output) output.innerText = "Audio Playback Error: " + e.message;
                        recognition.stop();
                    });
                }, 500);

                audio.onended = () => {
                    // Give a small buffer for the recognizer to catch the last words
                    setTimeout(() => {
                        recognition.stop();
                    }, 1000);
                };

            } catch (e) {
                console.error(e);
                if(output) output.innerText = "Engine Start Error.";
            }
        }

    </script>
</body>
</html>